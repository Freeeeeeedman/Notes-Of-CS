### 计算机网络面经总结


### 3. TCP

#### 3.4 半连接和全连接队列

1. 什么是TCP半连接队列和全连接队列？
    第一次握手,服务端收到客户端发起的 SYN 请求后， 内核会把该连接存储到半连接队列.第三次握⼿,服务端收到 ACK 后， 内核会把连接从半连接队列移除，然后创建新的完全的连接，并将其添加到 accept 队列，等待进程调⽤ accept 函数时把连接取出来。

2. 如何知道应⽤程序的 TCP 全连接队列⼤⼩？
    ss -lnt ,Recv-Q：当前全连接队列的⼤⼩,Send-Q：当前全连接最⼤队列⻓度，⾮ LISTEN 状态分别为已收到但未被应⽤进程读取的字节数,已发送但未收到确认的字节数

3. 如何模拟 TCP 全连接队列溢出的场景？
    wrk, HTTP 压测

4. TCP全连接队列溢出后会发生什么?
    默认⾏为tcp_abort_on_overflow = 0,服务器扔掉客户端发过来的ack.也可以设置tcp_abort_on_overflow = 1表示server发送⼀个reset复位报文给 client，表示废掉这个握⼿过程和这个连接.可以通过netstat -s | grep overflowed查看丢弃的连接数

5. tcp_abort_on_overflow为什么默认设置为0
    这样更有利于应对突发流量,提⾼连接建⽴的成功率.因为此时客户端连接状态为ESTABLISHED,只要服务器没有为请求回复 ACK，请求就会被多次重发.如果服务器上的进程只是短暂的繁忙造成 accept 队列满，那么当 TCP 全连接队列有空位时，再次接收到的请求报⽂由于含有 ACK，仍然会触发服务器端成功建⽴连接。只有当TCP 全连接队列会⻓期溢出时，才能设置为 1 以尽快通知客户端

6. 如何增⼤ TCP 全连接队列呢?
    TCP 全连接队列的最⼤值取决于 somaxconn(128) 和 backlog(511) 之间的最⼩值

7. 如何查看 TCP 半连接队列⻓度？
    服务端处于 SYN_RECV 状态的 TCP 连接数目，就是 TCP 半连接队列数目. nestat | grep SYN_RECV

8. 如何模拟 TCP 半连接队列溢出场景？
